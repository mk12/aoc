# Copyright 2022 Mitchell Kember. Subject to the MIT License.
# Advent of Code 2022
# Day 7: No Space Left On Device

âŸ¨Lines, N, SplitâŸ© â† â€¢Import "common.bqn"

Group â† (1-ËœÂ·+`'$'=âŠ‘Â¨)âŠ¸âŠ”
ParseCmd â† (âŠ‘â‹ˆ1â†“âŠ£)Â·' 'âŠ¸=âŠ¸Split 2â†“âŠ‘
ParseOut â† âŸ¨NÂ¨âŒ¾âŠË˜,1âŠ¸âŠË˜âŸ©{ğ•ğ•©}Â¨Â·>Â¨Â·(2âˆ¾Ëœ'd'=âŠ‘âŸ2Â¨)âŠ¸âŠ”Â·' 'âŠ¸=âŠ¸SplitÂ¨1â†“âŠ¢
steps â† >(ParseCmd âˆ¾ ParseOut)Â¨ Group Lines "2022_07"

# Navigates to directory index ğ•¨ in tree ğ•©.
Nav â† âŠ¢âŠ‘Â´2+âŠ£

# Changes to directory name ğ•¨, given wdâ€¿tree ğ•©. Returns the new directory index.
Cd â† {ğ•¨â‰¡"/" ? âŸ¨âŸ© ; ğ•¨â‰¡".." ? 1â†“âŠ‘ğ•© ; âŸ¨d,tâŸ©â†ğ•© â‹„ dâˆ¾Ëœ(<ğ•¨)âŠËœâŠ‘Â¨2â†“d Nav t}

# Inserts directory name ğ•¨ into tree ğ•©.
InsertDir â† âˆ¾âŸœ(â‹ˆâ‹ˆâŸœ0)Ëœ

# Inserts file sizeâ€¿name ğ•¨ into tree ğ•©.
InsertFile â† {(âŠ‘ğ•¨)âŠ¸+âŒ¾(1âŠ¸âŠ‘)ğ•©}

# Updates state ğ•© based on terminal interaction ğ•¨.
Update â† {
  âŸ¨wd, treeâŸ© â† ğ•©
  âŸ¨cmd, args, files, dirsâŸ© â† ğ•¨
  # â€¢Show âŸ¨"WD", wd, "TREE", treeâŸ©
  # â€¢Show âŸ¨"UPDATE", cmd, args, files, dirsâŸ©
  {cmdâ‰¡"cd" ?
  âŸ¨wdâ€¿tree CdËœ âŠ‘args, treeâŸ© ;
  âŸ¨wd, (InsertFileËâŸœfiles InsertDirÂ´âŸœdirs)âŒ¾(wdâŠ¸Nav) treeâŸ©}
}

# Aggregrates sizes up directories in tree ğ•©.
Agg â† {
  t â† ğ•ŠÂ¨âŒ¾(2âŠ¸â†“) ğ•©
  (+Â´1âŠ¸âŠ‘Â¨2â†“t)âŠ¸+âŒ¾(1âŠ¸âŠ‘) t
}

# Returns a flat list of directory sizes in tree ğ•©.
Sizes â† {âŸ¨1âŠ‘ğ•©âŸ©âˆ¾Â´ğ•ŠÂ¨2â†“ğ•©}

s â† Sizes Agg 1âŠ‘ âŸ¨âŸ©â€¿âŸ¨"/", 0âŸ© UpdateË âŒ½steps

# Part 1
â€¢Out +Â´â‰¤âŸœ1e5âŠ¸/s

# Part 2
tot â† 7e7
used â† Â¯1âŠ‘s
avail â† tot-used
need â† 3e7
save â† need-avail
â€¢Out âŒŠÂ´â‰¥âŸœsaveâŠ¸/s
