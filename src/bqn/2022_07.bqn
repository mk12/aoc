# Copyright 2022 Mitchell Kember. Subject to the MIT License.
# Advent of Code 2022
# Day 7: No Space Left On Device

âŸ¨Lines, N, SplitâŸ© â† â€¢Import "common.bqn"

# Helper functions for parsing.
Group â† (1-ËœÂ·+`'$'=âŠ‘Â¨)âŠ¸âŠ”
ParseCmd â† 1âŠ‘""<âŠ¸(âˆ¾Ëœ)Â·' 'âŠ¸=âŠ¸Split 2â†“âŠ‘
ParseOut â† âŸ¨+Â´Â·NÂ¨âŠË˜,1âŠ¸âŠË˜âŸ©{ğ•ğ•©}Â¨Â·>Â¨Â·(2âˆ¾Ëœ'd'=âŠ‘âŸ2Â¨)âŠ¸âŠ”Â·' 'âŠ¸=âŠ¸SplitÂ¨1â†“âŠ¢

# Table of steps, of the form âŸ¨dir, 0, âŸ¨âŸ©âŸ© for "cd" commands and 
# âŸ¨âŸ¨âŸ©, total_file_size, dirsâŸ© for "ls" commands.
steps â† >(ParseCmd<âŠ¸âˆ¾ParseOut)Â¨ Group Lines "2022_07"

# Navigates to directory ğ•¨ in tree ğ•©.
Nav â† âŠ¢âŠ‘Â´2+âŠ£

# Changes to directory named ğ•¨ given wdâ€¿tree ğ•©.
Cd â† {ğ•¨â‰¡"/" ? âŸ¨âŸ© ; ğ•¨â‰¡".." ? 1â†“âŠ‘ğ•© ; âŸ¨d,tâŸ©â†ğ•© â‹„ dâˆ¾Ëœ(<ğ•¨)âŠËœâŠ‘Â¨2â†“d Nav t}

# Updates state ğ•© based on step ğ•¨.
Update â† {
  âŸ¨dst, size, dirsâŸ©â€¿âŸ¨wd, treeâŸ© â† ğ•¨â€¿ğ•© â‹„ {
    0â‰ â‰ dst
    ? âŸ¨dst Cd wdâ€¿tree, treeâŸ©
    ; âŸ¨wd, (sizeâŠ¸+âŒ¾(1âŠ¸âŠ‘)(âˆ¾âŸœ(â‹ˆâ‹ˆâŸœ0)Ëœ)Â´âŸœdirs)âŒ¾(wdâŠ¸Nav) treeâŸ©
  }
}

# Aggregrates sizes up directories in tree ğ•©.
Agg â† {t â† ğ•ŠÂ¨âŒ¾(2âŠ¸â†“)ğ•© â‹„ (+Â´1âŠ¸âŠ‘Â¨2â†“t)âŠ¸+âŒ¾(1âŠ¸âŠ‘)t}

# Returns a list of directory sizes in tree ğ•©, root size last.
Sizes â† {âŸ¨1âŠ‘ğ•©âŸ©âˆ¾Â´ğ•ŠÂ¨2â†“ğ•©}

# List of directory sizes in the final tree.
x â† Sizes Agg 1âŠ‘ âŸ¨âŸ©â€¿âŸ¨"/", 0âŸ© UpdateË âŒ½steps

# Part 1
â€¢Out +Â´1e5âŠ¸â‰¥âŠ¸/x

# Part 2
â€¢Out âŒŠÂ´(4e7-ËœÂ¯1âŠ‘x)âŠ¸â‰¤âŠ¸/x
