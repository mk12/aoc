# Copyright 2022 Mitchell Kember. Subject to the MIT License.
# Advent of Code 2022
# Day 11: Monkey in the Middle

âŸ¨Cut, Lines, N, SplitâŸ© â† â€¢Import "common.bqn"

# Parses an expression like "old + 5" or "old * old" into a function.
ParseExpr â† {aâ€¿fâ€¿bâ†' 'âŠ¸=Â¨âŠ¸Split ğ•© â‹„ a(+â€¿Ã—âŠ‘Ëœ"+*"âŠf){ğ•¨âŠ¸ğ”½âŸœğ•©}â—‹{ğ•©â‰¡"old"?âŠ¢;Nğ•©}b}

# List of starting items and table of commands for each monkey. A command
# contains an operation, test divisor, and pair of true/false indices.
initâ€¿cmds â† âŠË˜âŠ¸â‹ˆâŸœ(1â€¿2âŠ¸âŠâŠ¸âˆ¾âŸœ(<3â€¿4âŠ¸âŠ)Ë˜)âŸ¨
  NÂ¨Â·(âˆ¨Ë" ,"=âŒœâŠ¢)âŠ¸Cut 18âŠ¸â†“, ParseExpr 19âŠ¸â†“, N 21âŠ¸â†“, N 29âŠ¸â†“, N 30âŠ¸â†“
âŸ©âŠ¸(âŠ£{ğ•ğ•©}Â¨(1+â†•5)âŠ¸âŠ)Ë˜â†‘â€¿7â¥ŠLines "2022_11"

# Constants: the number of monkeys, and the LCM of all test divisors.
m â† â‰ init
k â† â€¢math.LCMÂ´1âŠË˜cmds

# Simulates one turn using command ğ•¨ (function, divisor, true/false indices) on
# items ğ•©, returning a list of m lists with items grouped by their destination.
T â† {fâ€¿dâ€¿iâ†ğ•¨ â‹„ (âŠ¢âŠ”Ëœmâˆ¾ËœÂ·âŠ‘âŸœiÂ¨0â‰ d|âŠ¢)kâŠ¸|âˆ˜fğ•©}

# Simulates one round using commands ğ•¨ on itemsâ€¿counts ğ•©.
R â† {câ†ğ•¨ â‹„ ğ•©{sâ€¿nâ†ğ•© â‹„ aâ†ğ•¨âŠ‘s â‹„ âŸ¨(0âŠ¸â†‘âŒ¾(ğ•¨âŠ¸âŠ‘)s)âˆ¾Â¨(ğ•¨âŠc)T a, (â‰ a)âŠ¸+âŒ¾(ğ•¨âŠ¸âŠ‘)nâŸ©}Â´âŒ½â†•m}

# Returns the level of monkey business after ğ•¨ rounds using commands ğ•©.
MB â† {Ã—Â´2â†‘âˆ¨1âŠ‘ğ•©RâŸğ•¨initâ‹ˆmâ¥Š0}

# Part 1
â€¢Out 20 MB {âŒŠâˆ˜Ã·âŸœ3âˆ˜ğ•}âŒ¾âŠ‘Ë˜cmds

# Part 2
â€¢Out 1e4 MB cmds
