# Copyright 2022 Mitchell Kember. Subject to the MIT License.
# Advent of Code 2022
# Day 11: Monkey in the Middle

âŸ¨Cut, Lines, N, SplitâŸ© â† â€¢Import "common.bqn"

# Parses an expression like "old + 5" or "old * old" into a function.
ParseExpr â† {aâ€¿fâ€¿bâ†' 'âŠ¸=Â¨âŠ¸Split ğ•© â‹„ a(+â€¿Ã—âŠ‘Ëœ"+*"âŠf){ğ•¨âŠ¸ğ”½âŸœğ•©}â—‹{ğ•©â‰¡"old"?âŠ¢;Nğ•©}b}

# Lists of starting items for each monkey, and a table where each row contains
# four elements: operation, test divisor, and throwing index for true/false.
initâ€¿table â† âŠË˜âŠ¸â‹ˆâŸœ(1âŠ¸â†“Ë˜)âŸ¨
  NÂ¨Â·(âˆ¨Ë" ,"=âŒœâŠ¢)âŠ¸Cut 18âŠ¸â†“, ParseExpr 19âŠ¸â†“, N 21âŠ¸â†“, N 29âŠ¸â†“, N 30âŠ¸â†“
âŸ©âŠ¸(âŠ£{ğ•ğ•©}Â¨(1+â†•5)âŠ¸âŠ)Ë˜ â†‘â€¿7 â¥Š Lines "2022_11"

# Number of monkeys.
m â† â‰ init

# Least common multiple of all test divisors, to use as modulus.
k â† â€¢math.LCMÂ´1âŠË˜table

# Inspects item ğ•© given monkey table info ğ•¨, returning the new worry level and destination index.
I â† {fâ€¿dâ€¿tâ€¿eâ†ğ•¨ â‹„ (âŠ¢â‹ˆeâ€¿tâŠ‘Ëœ0=d|âŠ¢)k|fâ—‹âŠ¢ğ•©}

# Runs a turn on items ğ•© given monkey info ğ•¨, returning partial list of items.
Turn â† {((mâˆ¾Ëœ(1âŠ¸âŠ‘)Â¨)âŠ”âŠ‘Â¨) ğ•¨âŠ¸IÂ¨ğ•©}

Round â† {
  t â† ğ•¨
  ğ•©{
    # ğ•¨ is index, ğ•© is stateâ€¿nums
    sâ€¿nâ†ğ•©
    âŸ¨
      (0âŠ¸â†‘âŒ¾(ğ•¨âŠ¸âŠ‘)s)âˆ¾Â¨(ğ•¨âŠt)Turn(ğ•¨âŠ‘s)
      (â‰ ğ•¨âŠ‘s)âŠ¸+âŒ¾(ğ•¨âŠ¸âŠ‘)n
    âŸ©
  }Â´âŒ½â†•m
}

# Returns the level of monkey business after ğ•¨ rounds for table ğ•©.
MB â† {Ã—Â´2â†‘âˆ¨1âŠ‘ğ•© RoundâŸğ•¨initâ‹ˆmâ¥Š0}

# # Part 1
â€¢Out 20 MB {âŒŠâˆ˜(Ã·âŸœ3)âˆ˜ğ•}âŒ¾âŠ‘Ë˜ table

# # Part 2
â€¢Out 1e4 MB table
