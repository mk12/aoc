# Copyright 2022 Mitchell Kember. Subject to the MIT License.
# Advent of Code 2022
# Day 11: Monkey in the Middle

âŸ¨Cut, Lines, N, SplitâŸ© â† â€¢Import "common.bqn"

# Parses an expression like "old + 5" or "old * old" into a function.
ParseExpr â† {aâ€¿fâ€¿bâ†' 'âŠ¸=Â¨âŠ¸Split ğ•© â‹„ a(+â€¿Ã—âŠ‘Ëœ"+*"âŠf){ğ•¨âŠ¸ğ”½âŸœğ•©}â—‹{ğ•©â‰¡"old"?âŠ¢;Nğ•©}b}

# Lists of starting items for each monkey, and table of rules. Each rule has
# four elements: update function, test divisor, and true/false indices.
initâ€¿rules â† âŠË˜âŠ¸â‹ˆâŸœ(1âŠ¸â†“Ë˜)âŸ¨
  NÂ¨Â·(âˆ¨Ë" ,"=âŒœâŠ¢)âŠ¸Cut 18âŠ¸â†“
  ParseExpr 19âŠ¸â†“, N 21âŠ¸â†“, N 29âŠ¸â†“, N 30âŠ¸â†“
âŸ©âŠ¸(âŠ£{ğ•ğ•©}Â¨(1+â†•5)âŠ¸âŠ)Ë˜â†‘â€¿7â¥ŠLines "2022_11"

# Constants: the number of monkeys and the LCM of all test divisors.
m â† â‰ init
k â† â€¢math.LCMÂ´1âŠË˜rules

# Compiles a rule into a function that simulates a turn. That function takes a
# list of items returns inspected items grouped by destination index.
CompileTurn â† {fâ€¿dâ€¿tâ€¿eâ†ğ•© â‹„ (âŠ¢âŠ”Ëœmâˆ¾ËœÂ·âŠ‘âŸœeâ€¿tÂ¨0=d|âŠ¢)kâŠ¸|âˆ˜f}

# Compiles a list of rules into a function that simulates a round. That function
# takes sâ€¿c where s is a list like init and c is a list of inspection counts.
CompileRound â† {
  q â† âŒ½(â†•m)â‹ˆÂ¨(CompileTurnË˜ ğ•©)
  {
    {
      sâ€¿nâ†ğ•©
      iâ€¿câ†ğ•¨
      aâ†iâŠ‘s
      âŸ¨
        (âŸ¨âŸ©Ë™âŒ¾(iâŠ¸âŠ‘)s)âˆ¾Â¨câ—‹âŠ¢a,
        (â‰ a)âŠ¸+âŒ¾(iâŠ¸âŠ‘)n
      âŸ©
    }Â´âŸœq ğ•©
  }
}

# Simulates one round using compiled rules ğ•¨ on itemsâ€¿counts ğ•©.
# Round â† {
#   sâ€¿nâ†ğ•©
#   iâ€¿câ†ğ•¨
#   aâ†iâŠ‘s
#   âŸ¨
#     (âŸ¨âŸ©Ë™âŒ¾(iâŠ¸âŠ‘)s)âˆ¾Â¨câ—‹âŠ¢a,
#     (â‰ a)âŠ¸+âŒ¾(iâŠ¸âŠ‘)n
#   âŸ©
# }Â´âŸœ(âŒ½(â†•m)â‹ˆÂ¨âŠ¢)

# Returns the level of monkey business after ğ•¨ rounds using rules ğ•©.
MB â† {Ã—Â´2â†‘âˆ¨1âŠ‘(CompileRound ğ•©)âŸğ•¨initâ‹ˆmâ¥Š0}

# Part 1
â€¢Out 20 MB {âŒŠâˆ˜Ã·âŸœ3âˆ˜ğ•}âŒ¾âŠ‘Ë˜rules

# Part 2
â€¢Out 1e4 MB rules
